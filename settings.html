<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChildGuard ‚Äî Settings</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/forms.css" />
  <link rel="stylesheet" href="css/animations.css" />
  <link rel="stylesheet" href="css/responsive.css" />
</head>
<body>
<header class="app-header">
  <style>
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #0b2e75;
      color: white;
      padding: 10px 30px;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      object-fit: cover;
    }
    .app-title {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }
    .nav-bar {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 500;
    }
    .nav-link.active {
      background-color: #1a3fa7;
      padding: 6px 12px;
      border-radius: 8px;
    }
    .logout-btn {
      background-color: #ff4b4b;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    .profile-container {
      max-width: 500px;
      margin: 30px auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      background-color: white;
      position: relative;
    }

    .profile-container h2 {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .profile-field {
      margin-bottom: 15px;
    }
    .profile-field label {
      font-weight: 500;
      margin-bottom: 5px;
      display: block;
    }
    .profile-field span {
      display: block;
      padding: 8px 12px;
      border-radius: 6px;
      background-color: #f2f2f2;
      font-size: 16px;
    }

    .edit-btn {
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 6px;
      background-color: #1a3fa7;
      color: white;
      border: none;
      cursor: pointer;
    }

    .edit-form {
      display: none;
      margin-top: 20px;
    }

    .edit-form input {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    .edit-form .eye-btn {
      position: absolute;
      right: 15px;
      top: 33px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
    }

    .edit-form .btn {
      margin-top: 10px;
    }
  </style>

  <div class="logo-container">
    <img src="C:\Users\HP\Desktop\project001\parent_dashboard\assets\images\logo.jpg" alt="ChildGuard Logo" class="logo" />
    <h1 class="app-title">ChildGuard - Settings</h1>
  </div>
  
  <nav class="nav-bar">
    <a href="dashboard.html" class="nav-link">Home</a>
    <a href="add_child.html" class="nav-link">Add Child</a>
    <a href="settings.html" class="nav-link active">Settings</a>
    <button class="btn logout-btn" onclick="logoutParent()">Logout</button>
  </nav>
</header>

<main class="profile-container card fade-in">
  <h2>
    Profile
    <button class="edit-btn" id="editProfileBtn">Edit</button>
  </h2>

  <!-- Read-only profile info -->
  <div id="profileDisplay">
    <div class="profile-field">
      <label>Parent ID</label>
      <span id="displayParentId">‚Äî</span>
    </div>
    <div class="profile-field">
      <label>First Name</label>
      <span id="displayFirstName">‚Äî</span>
    </div>
    <div class="profile-field">
      <label>Last Name</label>
      <span id="displayLastName">‚Äî</span>
    </div>
    <div class="profile-field">
      <label>Email</label>
      <span id="displayEmail">‚Äî</span>
    </div>
    <div class="profile-field">
      <label>Phone</label>
      <span id="displayPhone">‚Äî</span>
    </div>
  </div>

  <!-- Editable form -->
  <form id="editForm" class="edit-form">
    <input type="text" id="editFirstName" placeholder="First Name" />
    <input type="text" id="editLastName" placeholder="Last Name" />
    <input type="email" id="editEmail" placeholder="Email" />
    <input type="text" id="editPhone" placeholder="Phone Number" />
    <div style="position: relative;">
      <input type="password" id="editPassword" placeholder="New Password" />
      <button type="button" class="eye-btn" id="toggleEditPassword">üëÅÔ∏è</button>
    </div>
    <button type="button" id="updateProfileBtn" class="btn primary btn-block">Save Changes</button>
  </form>
</main>

<footer class="app-footer">¬© 2025 ChildGuard</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/supabaseClient.js"></script>
<script>
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  async function fetchParentProfile() {
    const user = supabase.auth.user();
    if (!user) return;

    const { data, error } = await supabase
      .from('parents')
      .select('parent_id, first_name, last_name, email, phone')
      .eq('auth_id', user.id)
      .single();

    if (error) {
      console.error('Error fetching profile:', error);
      return;
    }

    // Display in read-only fields
    document.getElementById('displayParentId').textContent = data.parent_id;
    document.getElementById('displayFirstName').textContent = data.first_name || '';
    document.getElementById('displayLastName').textContent = data.last_name || '';
    document.getElementById('displayEmail').textContent = data.email || '';
    document.getElementById('displayPhone').textContent = data.phone || '';

    // Prefill editable form
    document.getElementById('editFirstName').value = data.first_name || '';
    document.getElementById('editLastName').value = data.last_name || '';
    document.getElementById('editEmail').value = data.email || '';
    document.getElementById('editPhone').value = data.phone || '';
  }

  // Toggle edit form visibility
  document.getElementById('editProfileBtn').addEventListener('click', () => {
    const form = document.getElementById('editForm');
    form.style.display = form.style.display === 'block' ? 'none' : 'block';
  });

  // Toggle password visibility
  document.getElementById('toggleEditPassword').addEventListener('click', () => {
    const pwInput = document.getElementById('editPassword');
    pwInput.type = pwInput.type === 'password' ? 'text' : 'password';
  });

  async function updateParentProfile() {
    const user = supabase.auth.user();
    if (!user) return;

    const first_name = document.getElementById('editFirstName').value;
    const last_name = document.getElementById('editLastName').value;
    const email = document.getElementById('editEmail').value;
    const phone = document.getElementById('editPhone').value;
    const password = document.getElementById('editPassword').value;

    // Update parent table
    const { error } = await supabase
      .from('parents')
      .update({ first_name, last_name, email, phone })
      .eq('auth_id', user.id);

    if (error) {
      alert('Error updating profile: ' + error.message);
      return;
    }

    // Update password if provided
    if (password) {
      const { error: passError } = await supabase.auth.update({ password });
      if (passError) {
        alert('Password update error: ' + passError.message);
        return;
      }
    }

    alert('Profile updated successfully!');
    document.getElementById('editPassword').value = '';
    document.getElementById('editForm').style.display = 'none';
    fetchParentProfile(); // refresh displayed info
  }

  document.getElementById('updateProfileBtn').addEventListener('click', updateParentProfile);

  function logoutParent() {
    supabase.auth.signOut().then(() => {
      window.location.href = 'index.html';
    });
  }

  // Fetch profile on page load
  fetchParentProfile();
</script>
</body>
</html>
